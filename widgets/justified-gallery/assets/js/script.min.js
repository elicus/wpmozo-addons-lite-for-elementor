!(function ($) {
    // Wait for Elementor to initialize
    $(window).on("elementor/frontend/init", function () {
        // Define a custom handler for the "wpmozo_ae_justified_gallery" widget
        var JustifiedGalleryHandler = elementorModules.frontend.handlers.Base.extend({
            // Bind events when the widget is initialized
            bindEvents: function () {
                this.change();
            },

            // Main function to handle changes and interactions
            change: function () {
                // Extend jQuery to add a custom pagination method
                $.fn.WPMozoJustifiedGalleryPagination = function (options = {}) {
                    // Default options for pagination
                    options = $.extend({}, {
                        paginationClass: "wpmozo_justified_gallery_pagination",
                        hideOnlyOnePage: true,
                        totalPages: 1,
                        visiblePages: 10,
                        startPage: 1,
                        initiateStartPageClick: false,
                        first: false,
                        last: false,
                        prev: false,
                        next: false
                    }, options);

                    // Initialize the pagination using the twbsPagination plugin
                    this.twbsPagination(options);
                };

                // When the document is ready, initialize the justified gallery
                $(document).ready(function ($) {
                    // Check if the justified gallery widget exists on the page
                    if ($(".elementor-widget-wpmozo_ae_justified_gallery").length > 0) {
                        // Loop through each instance of the widget
                        $(".elementor-widget-wpmozo_ae_justified_gallery").each(function () {
                            let $widget = $(this),
                                $galleryWrap = $widget.find(".wpmozo-justified-gallery-wrap"),
                                settings = $galleryWrap.data("settings");

                            // Configuration for the justified gallery
                            let galleryOptions = {
                                rowHeight: settings.row_height ? settings.row_height : 200,
                                captions: false,
                                margins: settings.column_spacing ? settings.column_spacing : 10,
                                lastRow: settings.lastrow_align ? settings.lastrow_align : "justify",
                                waitThumbnailsLoad: true,
                                refreshTime: 250,
                                filter: "div:not(.wpmozo-hidden-item)",
                                sizeRangeSuffixes: {
                                    lt100: "_t",
                                    lt240: "_m",
                                    lt320: "_n",
                                    lt500: "",
                                    lt640: "_z",
                                    lt1024: "_b"
                                }
                            };

                            // Initialize the justified gallery after images are loaded
                            $galleryWrap.find(".wpmozo-justified-gallery-container").imagesLoaded(function () {
                                $galleryWrap.find(".wpmozo-justified-gallery-container").justifiedGallery(galleryOptions);
                            });

                            // Handle "Load More" button click
                            if ($(".wpmozo-justified-gallery-load-more").length > 0) {
                                $galleryWrap.find(".wpmozo-justified-gallery-load-more").on("click", function (e) {
                                    e.preventDefault();
                                    let $button = $(this),
                                        loadMoreOptions = $button.parent().data("options");

                                    // Update settings and disable the button during loading
                                    settings = $galleryWrap.data("settings");
                                    $button.css("opacity", "0.5").prop("disabled", true);

                                    // Determine the active filter
                                    let filter = "";
                                    if ($galleryWrap.find(".wpmozo-justified-gallery-filter").length > 0) {
                                        filter = $galleryWrap.find(".wpmozo-justified-gallery-filter li.active a").data("filter");
                                    }
                                    if (filter === "*") filter = "";

                                    // Calculate pagination details
                                    let itemsPerPage = loadMoreOptions.images_per_page ? loadMoreOptions.images_per_page : 8,
                                        totalItems = parseInt($galleryWrap.find(".wpmozo-justified-gallery-item" + filter).length),
                                        totalPages = Math.ceil(totalItems / parseInt(itemsPerPage)),
                                        currentPage = loadMoreOptions.page ? loadMoreOptions.page : 2;

                                    // Hide the button if there are no more items to load
                                    if (currentPage > totalPages) {
                                        $button.hide();
                                        return;
                                    }

                                    // Show the next set of items
                                    let startIndex = 0,
                                        endIndex = itemsPerPage;
                                    if (currentPage !== 1) {
                                        startIndex = itemsPerPage * (currentPage - 1);
                                        endIndex = itemsPerPage * currentPage;
                                    }

                                    for (let i = startIndex; i < endIndex; i++) {
                                        $galleryWrap.find(".wpmozo-justified-gallery-item.wpmozo-hidden-item" + filter + ":first").removeClass("wpmozo-hidden-item");
                                    }

                                    // Reinitialize the justified gallery after loading new items
                                    $galleryWrap.find(".wpmozo-justified-gallery-container")
                                        .justifiedGallery(galleryOptions)
                                        .on("jg.complete", function () {
                                            $galleryWrap.find(".wpmozo-justified-gallery-container .wpmozo-justified-gallery-item").fadeIn("slow");
                                        });

                                    // Update the page number and re-enable the button
                                    loadMoreOptions.page = parseInt(loadMoreOptions.page) + 1;
                                    $button.parent().data("options", loadMoreOptions);
                                    $button.css("opacity", "1").prop("disabled", false);

                                    // Hide the button if all items are loaded
                                    if (endIndex >= totalItems) {
                                        $button.hide();
                                    }
                                });
                            }

                            // Handle pagination if the widget has a pagination wrapper
                            if ($galleryWrap.find(".wpmozo_button_wrapper ul").length > 0) {
                                let $paginationWrapper = $galleryWrap.find(".wpmozo_button_wrapper"),
                                    $paginationList = $paginationWrapper.find("ul"),
                                    paginationOptions = $paginationWrapper.data("options");

                                // Determine the active filter
                                let filter = "";
                                if ($galleryWrap.find(".wpmozo-justified-gallery-filter").length > 0) {
                                    filter = $galleryWrap.find(".wpmozo-justified-gallery-filter li.active a").data("filter");
                                }
                                if (filter === "*") filter = "";

                                // Calculate pagination details
                                let itemsPerPage = paginationOptions.images_per_page ? paginationOptions.images_per_page : 8,
                                    totalItems = parseInt(paginationOptions.total_images),
                                    totalPages = Math.ceil(totalItems / parseInt(itemsPerPage));

                                // Initialize the pagination
                                $paginationList.WPMozoJustifiedGalleryPagination({
                                    totalPages: totalPages,
                                    onPageClick: function (event, page) {
                                        let startIndex = 0,
                                            endIndex = itemsPerPage;
                                        if (page !== 1) {
                                            startIndex = itemsPerPage * (page - 1);
                                            endIndex = itemsPerPage * page;
                                        }

                                        // Hide all items and show only the ones for the current page
                                        $galleryWrap.find(".wpmozo-justified-gallery-container .wpmozo-justified-gallery-item").addClass("wpmozo-hidden-item");
                                        $galleryWrap.find(".wpmozo-justified-gallery-container .wpmozo-justified-gallery-item.wpmozo-hidden-item" + filter).each(function (index) {
                                            if (index + 1 > startIndex && index + 1 <= endIndex) {
                                                $(this).removeClass("wpmozo-hidden-item");
                                            }
                                        });

                                        // Reinitialize the justified gallery after pagination
                                        $galleryWrap.find(".wpmozo-justified-gallery-container")
                                            .justifiedGallery(galleryOptions)
                                            .on("jg.complete", function () {
                                                $galleryWrap.find(".wpmozo-justified-gallery-container .wpmozo-justified-gallery-item").fadeIn("slow");
                                            });

                                        // Scroll to the gallery if it's not in view
                                        if ($galleryWrap.offset().top > 0) {
                                            let scrollOffset = 0;
                                            if ($("body").find("#top-header").length > 0 && $("body").hasClass("et_fixed_nav")) {
                                                scrollOffset += parseFloat($("#top-header").innerHeight());
                                            }
                                            if ($("body").find("#main-header").length > 0 && $("body").hasClass("et_fixed_nav")) {
                                                scrollOffset += parseFloat($("#main-header").innerHeight());
                                            }
                                            if ($("body").find(".et-l--header").length > 0 && $("body").find(".et-l--header .et_builder_inner_content").hasClass("has_et_pb_sticky")) {
                                                scrollOffset += parseFloat($(".et-l--header").innerHeight());
                                            }
                                            scrollOffset += 50;

                                            $("html, body").animate({
                                                scrollTop: $galleryWrap.offset().top - scrollOffset
                                            });
                                        }
                                    }
                                });

                                // Add previous and next buttons if enabled
                                if (paginationOptions.show_prev_next === "yes") {
                                    $paginationList.WPMozoJustifiedGalleryPagination({
                                        prev: paginationOptions.prev_text,
                                        next: paginationOptions.next_text
                                    });
                                }
                            }

                            // Handle filter clicks
                            $galleryWrap.find(".wpmozo-justified-gallery-filter a").on("click", function (e) {
                                e.preventDefault();
                                let $filterLink = $(this);

                                // Skip if the filter is already active
                                if ($filterLink.parent().hasClass("active")) return false;

                                // Get the filter value
                                let filter = $filterLink.data("filter");
                                if (filter === "*") filter = "";

                                // Update the gallery based on the selected filter
                                $galleryWrap.find(".wpmozo-justified-gallery-container .wpmozo-justified-gallery-item").addClass("wpmozo-hidden-item");
                                $galleryWrap.find(".wpmozo-justified-gallery-container .wpmozo-justified-gallery-item" + filter).removeClass("wpmozo-hidden-item");

                                // Reinitialize the justified gallery
                                $galleryWrap.find(".wpmozo-justified-gallery-container")
                                    .justifiedGallery(galleryOptions)
                                    .on("jg.complete", function () {
                                        $galleryWrap.find(".wpmozo-justified-gallery-container .wpmozo-justified-gallery-item").fadeIn("slow");
                                    });

                                // Update the active filter
                                $galleryWrap.find(".wpmozo-justified-gallery-filter li").removeClass("active");
                                $filterLink.parent().addClass("active");
                            });

                            // Handle lightbox or zoom functionality
                            if (settings.click_trigger && (settings.click_trigger === "lightbox" || settings.click_trigger === "zoom_n_link")) {
                                let lightboxClass = $widget.closest(".elementor-widget-wpmozo_ae_justified_gallery").prop("class").match(/(elementor-widget-wpmozo_ae_justified_gallery)/)[0] + "_lightbox",
                                    lightboxEffect = settings.lightbox_effect,
                                    lightboxTransitionDuration = lightboxEffect !== "none" ? parseInt(settings.lightbox_transition_duration) : 0,
                                    enableNavigation = settings.enable_navigation === "yes",
                                    lightboxSelector = settings.click_trigger === "zoom_n_link" ? ".wpmozo-justified-gallery-item .wpmozo-overlay-lightbox" : ".wpmozo-justified-gallery-item figure",
                                    widgetId = "elementor-element-" + $(this).data("id");

                                // Initialize the lightbox
                                $galleryWrap.magnificPopup({
                                    delegate: lightboxSelector,
                                    type: "image",
                                    removalDelay: lightboxTransitionDuration,
                                    closeOnContentClick: false,
                                    closeBtnInside: false,
                                    mainClass: `elementor-element mfp-with-zoom mfp-img-mobile wpmozo_justified_gallery_lightbox ${lightboxClass} wpmozo_mfp_${lightboxEffect} ${widgetId}`,
                                    prependTo: $(this).closest(".elementor"),
                                    gallery: {
                                        enabled: enableNavigation,
                                        navigateByImgClick: false,
                                        tPrev: "",
                                        tNext: "",
                                        tCounter: ""
                                    },
                                    zoom: {
                                        enabled: lightboxEffect === "zoom",
                                        duration: lightboxTransitionDuration,
                                        easing: "ease-in-out",
                                        opener: function (element) {
                                            return element;
                                        }
                                    },
                                    image: {
                                        markup: '<div class="mfp-figure"><div class="mfp-close"></div><div class="mfp-img"></div><div class="mfp-bottom-bar"><div class="mfp-title"></div></div></div>',
                                        titleSrc: function (item) {
                                            if (settings.click_trigger === "zoom_n_link") {
                                                return item.el.parents(".wpmozo-justified-gallery-item").find("figcaption .wpmozo-item-content").length > 0
                                                    ? item.el.parents(".wpmozo-justified-gallery-item").find("figcaption .wpmozo-item-content").prop("outerHTML")
                                                    : "";
                                            } else {
                                                return item.el.find("figcaption .wpmozo-item-content").length > 0
                                                    ? item.el.find("figcaption .wpmozo-item-content").prop("outerHTML")
                                                    : "";
                                            }
                                        },
                                        tError: '<a href="%url%">The image</a> could not be loaded.'
                                    },
                                    allowHTMLInTemplate: true
                                });
                            }
                        });
                    }
                });
            }
        });

        // Attach the custom handler to the Elementor widget
        elementorFrontend.elementsHandler.attachHandler("wpmozo_ae_justified_gallery", JustifiedGalleryHandler);
    });
})(jQuery);